<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="erd">
	<!-- erd 생성 모든 컬럼 -->
	<insert id="addErdFull" parameterType="erdVo">
		insert into erd
			(erdno, erdtitle, erdscope, erdreadcnt, erdcdt, erdudt, erdcolor, memid, teamno)
		values
			(seq_erdno.nextval, #{erdTitle}, #{erdScope}, #{erdReadCnt}, sysdate, sysdate, #{erdColor}, #{memId}, #{teamNo})
	</insert>
	
	<!-- erd 생성하기 -->
	<insert id="addErd" parameterType="erdVo">
		<selectKey keyProperty="erdNo" resultType="int" order="BEFORE">
   			 select seq_erdno.nextval FROM DUAL
  		</selectKey>
		insert into erd
			(erdno, erdtitle, erdscope, erdcdt, erdudt, memid, teamno)
		values
			(#{erdNo}, #{erdTitle}, #{erdScope}, sysdate, sysdate, #{memId, jdbcType=VARCHAR}, nullif(#{teamNo},0))
			
	</insert>
	
	<!-- 나의 Erd리스트 가져오기 -->
	<select id="getMyErdList" parameterType="String" resultType="erdVo">
		select *
		from erd
		where memid = #{memId}
		order by erdudt desc
	</select>
	
	<!-- erd 삭제 -->
	<delete id="delErd" parameterType="int">
		delete from erd where erdno = #{erdNo}
	</delete>
	
	<!-- 모든 Erd리스트 가져오기 -->
	<select id="getAllErdList" resultType="erdVo">
		select *
		from erd
		order by erdudt desc
	</select>
	
	<!-- 모든 public ERD 페이징 리스트 -->
	<select id="getAllErdListPaging" parameterType="pageVo" resultType="erdVo">
		select *
		from
			( select a.*, rownum rn
		      from
		        (select erd.*
		         from erd
		         where erdscope = 'public'
		         order by erdudt desc
		        ) a
		    )
		where rn between ((#{pageNo}-1)*#{pageSize})+1 and (#{pageNo})*#{pageSize}
	</select>
	
	<!-- 모든 erd 개수 -->
	<select id="getAllErdCnt" resultType="int">
		select count(*)
		from erd
	</select>
	
	<!-- 검색용 public ERD 페이징 리스트 -->
	<select id="searchPagingList" parameterType="pageVo" resultType="erdVo">
		select e.*           
		from (select d.*, rownum rn                
		      from (select c.*        
		            from(select a.*
		                 from erd a 
		                 where 
		                    erdtitle like '%'||#{search}||'%'
		                    and a.erdscope = 'public' <!--  erdtitle에 1이 들어있는 애들 -->   
		            union 
		                select a.*
		                from erd a, tag b ,tag_hist c
		                where a.erdno = c.erdno
		                    and b.tagno = c.tagno
		                    and b.tagcontent like '%'||#{search}||'%' <!-- tag에  1이 들어있는애들 -->
		                    and a.erdscope = 'public') c
		      order by c.erdudt desc) d
		      ) e
		where rn between ((#{pageNo}-1)*#{pageSize})+1 and (#{pageNo})*#{pageSize}
	
	</select>
	<!-- 검색용 public erd 리스트-->
	<select id="searchList" parameterType="String" resultType="erdVo">
		select d.*, rownum rn                
		      from (select c.*        
		            from(select a.*
		                 from erd a 
		                 where 
		                    erdtitle like '%'||#{search}||'%'
		                    and a.erdscope = 'public' <!--  erdtitle에 1이 들어있는 애들 -->   
		            union 
		                select a.*
		                from erd a, tag b ,tag_hist c
		                where a.erdno = c.erdno
		                    and b.tagno = c.tagno
		                    and b.tagcontent like '%'||#{search}||'%' <!-- tag에  1이 들어있는애들 -->
		                    and a.erdscope = 'public') c
		      order by c.erdudt desc) d
	</select>
</mapper>